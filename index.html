<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<!-- 手機顯示比例正確，避免自動放大；照顧 iOS 瀏海安全區 -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<meta name="format-detection" content="telephone=no">
<title>新商品申請</title>
<style>
:root{--border:#e5e7eb;--muted:#64748b;--text:#0f172a;--brand:#2563eb;--bad:#dc2626;--bg:#f8fafc;--surface:#fff}
*{box-sizing:border-box}
html,body{-webkit-text-size-adjust:100%;}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif}
.wrap{max-width:900px;margin:22px auto;padding:0 12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:18px}
h1{margin:0 0 6px;text-align:center;font-size:22px;display:flex;align-items:center;justify-content:center;gap:10px}
h1 img.logo{height:1.2em; display:inline-block; vertical-align:middle}
h1 span{color:var(--brand)}
.hint{margin:0 0 14px;text-align:center;color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-full{grid-column:1/-1}
.label{font-weight:700;font-size:13px;margin-bottom:6px}
.input,.select,.textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:15px;touch-action:manipulation}
.textarea{min-height:84px;resize:vertical}
.hr{height:1px;background:var(--border);margin:12px 0}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{cursor:pointer;flex:1;min-width:140px;border-radius:12px;padding:12px 14px;font-weight:700;border:1px solid var(--border);background:#fff}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-danger{border-color:#fecaca;color:#b91c1c}
.small{font-size:12px;color:var(--muted)}
.error{color:var(--bad)}
.product{border:1px dashed var(--border);border-radius:12px;padding:12px;margin:8px 0;background:#fff}
.preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.preview .thumb{position:relative}
.preview img{width:80px;height:80px;border-radius:8px;object-fit:cover;border:1px solid #ddd;display:block}
.preview .rm{position:absolute;top:-6px;right:-6px;border:none;background:#ef4444;color:#fff;width:20px;height:20px;border-radius:9999px;cursor:pointer;line-height:20px;font-size:12px}

/* 小於 720px 單欄 */
@media (max-width:720px){.grid{grid-template-columns:1fr}}

/* 900px 以下：手機優化，16px 防止 iOS 放大 */
@media (max-width: 900px) {
  html, body { -webkit-text-size-adjust: 100%; }
  body { font-size: 16px; }
  .wrap{
    max-width:none !important; width:100% !important; margin:0 !important;
    padding-left:max(12px, env(safe-area-inset-left)) !important;
    padding-right:max(12px, env(safe-area-inset-right)) !important;
    padding-top:14px !important; padding-bottom:14px !important;
  }
  .card{
    padding:16px !important;
    border-left:none !important; border-right:none !important;
    box-shadow:none !important;
    border-radius:12px !important;
  }
  .grid{ grid-template-columns:1fr !important; gap:12px !important; }
  .grid > *{ min-width:0 !important; }
  .input,.select,.textarea,input,select,textarea{
    font-size:16px !important; padding:14px 16px !important; width:100% !important;
  }
  .actions{ flex-direction:column !important; gap:10px !important; }
  .btn{ width:100% !important; min-width:0 !important; padding:14px 16px !important; font-size:16px !important; }
  .preview img,.thumb{ width:72px !important; height:72px !important; }
}

/* 強制手機單欄（保險） */
html.force-mobile .wrap{
  max-width:none !important; width:100% !important; margin:0 !important;
  padding-left:max(12px, env(safe-area-inset-left)) !important;
  padding-right:max(12px, env(safe-area-inset-right)) !important;
  padding-top:14px !important; padding-bottom:14px !important;
}
html.force-mobile .card{
  padding:16px !important; border-left:none !important; border-right:none !important;
  box-shadow:none !important; border-radius:12px !important;
}
html.force-mobile .grid{ grid-template-columns:1fr !important; gap:12px !important; }
html.force-mobile .grid > *{ min-width:0 !important; }
html.force-mobile .input, html.force-mobile .select, html.force-mobile .textarea,
html.force-mobile input, html.force-mobile select, html.force-mobile textarea{
  font-size:16px !important; padding:14px 16px !important; width:100% !important;
}
html.force-mobile .actions{ flex-direction:column !important; gap:10px !important; }
html.force-mobile .btn{ width:100% !important; min-width:0 !important; padding:14px 16px !important; font-size:16px !important; }
html.force-mobile .preview img, html.force-mobile .thumb{ width:72px !important; height:72px !important; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>
      <img class="logo" id="logo" alt="KenSu" src="" />
      <span>啃酥新商品申請</span>
    </h1>
    <p class="hint">所有欄位必填</p>
    <div class="hr"></div>

    <form id="f" novalidate>
      <div class="grid">
        <div><div class="label">分店/單位 *</div><input class="input" name="store" required placeholder="例如：啃酥xx店"></div>
        <div><div class="label">申請人 *</div><input class="input" name="applicant" required placeholder="你的姓名"></div>
        <div><div class="label">Email *</div><input class="input" name="email" type="email" required placeholder="name@example.com"></div>
        <div><div class="label">電話 *</div><input class="input" name="phone" required placeholder="0900-000-000"></div>
        <div class="grid-full"><div class="label">備註 *</div><textarea class="textarea" name="remark" required placeholder="其他補充、注意事項…"></textarea></div>
      </div>

      <div class="hr"></div>
      <div class="label">申請品項 *</div>
      <div id="products"></div>
      <div class="actions"><button class="btn" type="button" id="add">＋新增一個品項</button></div>

      <div class="actions">
        <button class="btn btn-danger" type="button" id="resetBtn">清空</button>
        <button class="btn btn-primary" type="submit" id="submitBtn">送出申請</button>
      </div>
      <div id="msg" class="small" style="margin-top:8px"></div>
    </form>

    <div id="done" style="display:none;text-align:center;padding:16px">
      <h3>✅ 已送出</h3>
      <p class="small">我們已收到你的申請，請留意審核通知。</p>
      <div id="applyNo" class="small" style="margin-top:6px;"></div>
    </div>
  </div>
</div>

<template id="tpl">
  <div class="product">
    <div class="grid">
      <div><div class="label">商品名稱 *</div><input class="input p-name" required></div>
      <div><div class="label">規格/包裝 *</div><input class="input p-spec" required></div>
      <div><div class="label">建議售價 *</div><input class="input p-price" required></div>
      <div><div class="label">成本 *</div><input class="input p-cost" required></div>
      <div>
        <div class="label">素別 *</div>
        <select class="select p-veg" required>
          <option value="">請選擇</option><option>葷食</option><option>蛋奶素</option><option>奶素</option><option>蛋素</option><option>全素</option>
        </select>
      </div>
      <div><div class="label">過敏原 *</div><input class="input p-allg" required placeholder="蛋, 奶, 花生…"></div>
      <div class="grid-full"><div class="label">成分/原料 *</div><textarea class="textarea p-ings" required placeholder="主要原料…"></textarea></div>
      <div><div class="label">保存期限 *</div><input class="input p-life" required placeholder="常溫/冷藏/冷凍 + 月數"></div>
      <div><div class="label">保存方式 *</div><input class="input p-store" required placeholder="常溫/冷藏/冷凍"></div>
      <div>
        <div class="label">供應型態 *</div>
        <select class="select p-supply" required>
          <option>常態供應</option><option>季節限定</option><option>試賣</option>
        </select>
      </div>
      <div><div class="label">預計上架日 *</div><input class="input p-launch" type="date" required></div>

      <div class="grid-full">
        <div class="label">商品圖片（拍照或選擇相簿上傳）</div>
        <input class="input p-img" type="file" accept="image/*" capture="environment" multiple>
        <div class="preview"></div>
      </div>
    </div>
    <div class="actions"><button class="btn btn-danger" type="button" onclick="removeProduct(this)">刪除此品項</button></div>
  </div>
</template>

<script>
/* ========= 你需要修改的地方 ========= */
// ⚠️ 換成你最新部署的 GAS /exec URL
const ENDPOINT = 'https://script.google.com/macros/s/AKfycby7w2EvlrBlfNoLvFrPB9JTbHgPaDvGHyoryOFU73PPnWpPJ04Z6fq0Pwhd3OWbtkhS/exec';

// A. 用公開圖檔 URL（建議）
const LOGO_URL = 'https://raw.githubusercontent.com/your-org/your-repo/main/logo.png';
// B. 可選：用 Drive 檔案 ID，前端會呼叫 ENDPOINT?fn=logo&fileId=... 取得 dataURL（需後端支援）
const LOGO_FILE_ID = ''; // 例如 '14OhrEALBrL1MgfeXlsvI8Qwh_HBcZgxR'

/* ===== 常數（本地快取） ===== */
const AUTOSAVE_KEY = 'kensu-new-product-form.v1';

/* ===== DOM ===== */
const f = document.getElementById('f');
const addBtn = document.getElementById('add');
const productsBox = document.getElementById('products');
const tpl = document.getElementById('tpl');
const msg = document.getElementById('msg');
const submitBtn = document.getElementById('submitBtn');
const done = document.getElementById('done');
const applyNoEl = document.getElementById('applyNo');

/* ===== (新增) 偵測實體手機，強制進入手機樣式 ===== */
(function forceMobileIfSmallDevice(){
  try{
    const sw = Math.min(window.screen.width || 0, window.screen.height || 0);
    const coarse = window.matchMedia && window.matchMedia('(hover:none) and (pointer:coarse)').matches;
    if ((sw && sw <= 480) || coarse) document.documentElement.classList.add('force-mobile');
  }catch(_){}
})();

/* ===== 圖片預覽與刪除 ===== */
function bindImagePreview(container) {
  const input = container.querySelector('.p-img');
  const preview = container.querySelector('.preview');
  input.addEventListener('change', () => {
    preview.innerHTML = '';
    const files = Array.from(input.files);
    files.forEach((file, idx) => {
      const fr = new FileReader();
      fr.onload = e => {
        const wrap = document.createElement('div');
        wrap.className = 'thumb';
        const img = document.createElement('img');
        img.src = e.target.result;
        const rm = document.createElement('button');
        rm.className = 'rm'; rm.type = 'button'; rm.textContent = '×';
        rm.onclick = () => {
          const list = Array.from(input.files);
          list.splice(idx, 1);
          const dt = new DataTransfer();
          list.forEach(f => dt.items.add(f));
          input.files = dt.files;
          wrap.remove();
        };
        wrap.appendChild(img); wrap.appendChild(rm);
        preview.appendChild(wrap);
      };
      fr.readAsDataURL(file);
    });
  });
}

/* ===== 新增/刪除品項 ===== */
function addProduct(prefill){
  const node = tpl.content.cloneNode(true);
  productsBox.appendChild(node);
  const card = productsBox.lastElementChild;
  bindImagePreview(card);
  if (prefill) {
    card.querySelector('.p-name').value   = prefill.product_name || '';
    card.querySelector('.p-spec').value   = prefill.spec || '';
    card.querySelector('.p-price').value  = prefill.price_suggest || '';
    card.querySelector('.p-cost').value   = prefill.cost || '';
    card.querySelector('.p-veg').value    = prefill.vegetarian || '';
    card.querySelector('.p-allg').value   = prefill.allergens || '';
    card.querySelector('.p-ings').value   = prefill.ingredients || '';
    card.querySelector('.p-life').value   = prefill.shelf_life || '';
    card.querySelector('.p-store').value  = prefill.storage || '';
    card.querySelector('.p-supply').value = prefill.supply_type || '常態供應';
    card.querySelector('.p-launch').value = prefill.launch_date || '';
  }
}
function removeProduct(btn){
  const card=btn.closest('.product');
  if(productsBox.querySelectorAll('.product').length<=1){ alert('至少需要一個品項'); return; }
  card.remove();
  saveForm();
}
window.removeProduct = removeProduct;

/* ===== 驗證 ===== */
function validate(){
  const need=[f.store,f.applicant,f.email,f.phone,f.remark];
  for(const el of need){ if(!el.value.trim()) return '請完整填寫共同欄位'; }
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email.value.trim())) return 'Email 格式不正確';
  const cards=productsBox.querySelectorAll('.product');
  if(!cards.length) return '請至少新增一個品項';
  for(const card of cards){
    const req=['.p-name','.p-spec','.p-price','.p-cost','.p-veg','.p-allg','.p-ings','.p-life','.p-store','.p-supply','.p-launch'];
    for(const sel of req){
      const el=card.querySelector(sel);
      if(!el || !String(el.value||'').trim()) return '每個品項所有欄位皆為必填';
    }
  }
  return '';
}

/* ===== File -> base64 ===== */
function fileToData(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = e => {
      const dataUrl = e.target.result;
      const comma = dataUrl.indexOf(',');
      resolve({
        name: file.name || 'upload',
        type: file.type || 'application/octet-stream',
        data: dataUrl.slice(comma+1)
      });
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

/* ===== 收集 ===== */
async function gatherForm(){
  const products=[];
  for(const card of productsBox.querySelectorAll('.product')){
    const get=sel=>card.querySelector(sel).value.trim();
    const input = card.querySelector('.p-img');
    const files = Array.from(input.files);
    const photos = await Promise.all(files.map(fileToData));
    products.push({
      product_name:get('.p-name'),
      spec:get('.p-spec'),
      price_suggest:get('.p-price'),
      cost:get('.p-cost'),
      vegetarian:card.querySelector('.p-veg').value,
      allergens:get('.p-allg'),
      ingredients:get('.p-ings'),
      shelf_life:get('.p-life'),
      storage:get('.p-store'),
      supply_type:card.querySelector('.p-supply').value,
      launch_date:card.querySelector('.p-launch').value,
      photos
    });
  }
  return {
    store: f.store.value.trim(),
    applicant: f.applicant.value.trim(),
    email: f.email.value.trim(),
    phone: f.phone.value.trim(),
    remark: f.remark.value.trim(),
    products
  };
}

/* ===== 自動儲存（localStorage） ===== */
const AUTOSAVE_FIELDS_SELECTOR = 'input, textarea, select';
function saveForm(){
  try{
    const data = {
      store: f.store.value || '',
      applicant: f.applicant.value || '',
      email: f.email.value || '',
      phone: f.phone.value || '',
      remark: f.remark.value || '',
      products: Array.from(productsBox.querySelectorAll('.product')).map(card=>({
        product_name: card.querySelector('.p-name').value || '',
        spec:         card.querySelector('.p-spec').value || '',
        price_suggest:card.querySelector('.p-price').value || '',
        cost:         card.querySelector('.p-cost').value || '',
        vegetarian:   card.querySelector('.p-veg').value || '',
        allergens:    card.querySelector('.p-allg').value || '',
        ingredients:  card.querySelector('.p-ings').value || '',
        shelf_life:   card.querySelector('.p-life').value || '',
        storage:      card.querySelector('.p-store').value || '',
        supply_type:  card.querySelector('.p-supply').value || '常態供應',
        launch_date:  card.querySelector('.p-launch').value || ''
      }))
    };
    localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
  }catch(e){}
}
function loadForm(){
  try{
    const raw = localStorage.getItem(AUTOSAVE_KEY);
    if (!raw) { productsBox.innerHTML=''; addProduct(); return; }
    const data = JSON.parse(raw);
    f.store.value = data.store || '';
    f.applicant.value = data.applicant || '';
    f.email.value = data.email || '';
    f.phone.value = data.phone || '';
    f.remark.value = data.remark || '';
    productsBox.innerHTML = '';
    const list = Array.isArray(data.products) && data.products.length ? data.products : [{}];
    list.forEach(p => addProduct(p));
  }catch(_){
    productsBox.innerHTML = '';
    addProduct();
  }
}
function clearSaved(){ localStorage.removeItem(AUTOSAVE_KEY); }

/* ===== 綁定 & 送出 ===== */
async function initBindings(){
  // 設定 LOGO
  const logoEl = document.getElementById('logo');
  if (LOGO_FILE_ID) {
    try{
      const r = await fetch(`${ENDPOINT}?fn=logo&fileId=${encodeURIComponent(LOGO_FILE_ID)}`, { method:'GET', mode:'cors' });
      const j = await r.json();
      if (j && j.ok && j.dataUrl) logoEl.src = j.dataUrl; else logoEl.src = LOGO_URL || '';
    }catch(_){ logoEl.src = LOGO_URL || ''; }
  } else {
    logoEl.src = LOGO_URL || '';
  }

  addBtn.addEventListener('click', ()=>{ addProduct(); saveForm(); });
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    f.reset(); productsBox.innerHTML=''; addProduct(); msg.textContent='';
    clearSaved();
  });

  ['input','change'].forEach(evt=>{
    f.addEventListener(evt, (e)=>{ if (e.target.matches(AUTOSAVE_FIELDS_SELECTOR)) saveForm(); });
  });
  productsBox.addEventListener('input', (e)=>{ if (e.target.matches(AUTOSAVE_FIELDS_SELECTOR)) saveForm(); });
  productsBox.addEventListener('change', (e)=>{ if (e.target.matches(AUTOSAVE_FIELDS_SELECTOR)) saveForm(); });

  loadForm();

  // 送出
  f.addEventListener('submit', async e=>{
    e.preventDefault();
    msg.textContent='';
    const err=validate();
    if(err){ msg.textContent='⚠️ '+err; return; }

    try{
      submitBtn.disabled=true;
      submitBtn.textContent='送出中…';
      const payload = await gatherForm();

      // ✅ 關鍵：不自訂 application/json，避免預檢（OPTIONS）被擋
      const res = await fetch(ENDPOINT, {
        method: 'POST',
        mode: 'cors',
        body: JSON.stringify({ fn:'processForm', data: payload })
      });

      const j = await res.json();
      if (!j || !j.ok) throw new Error((j && j.message) || '後端未回傳成功狀態');

      clearSaved();
      f.style.display='none';
      done.style.display='block';
      applyNoEl.textContent = '申請編號：' + (j.applyNo || '');
      submitBtn.disabled=false;
      submitBtn.textContent='送出申請';
    }catch(ex){
      let hint = '';
      if (String(ex).includes('Failed to fetch')) {
        hint = '（常見：/exec 不是最新、部署權限不是「任何人」、或圖片總大小過大）';
      }
      msg.innerHTML = `<span class="error">❌ 送出失敗：</span>${(ex && ex.message) || ex} ${hint}`;
      submitBtn.disabled=false;
      submitBtn.textContent='送出申請';
    }
  });
}
document.addEventListener('DOMContentLoaded', initBindings);
</script>
</body>
</html>
