<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ–°å•†å“ç”³è«‹</title>
<style>
:root{--border:#e5e7eb;--muted:#64748b;--text:#0f172a;--brand:#2563eb;--bad:#dc2626;--bg:#f8fafc;--surface:#fff}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif}
.wrap{max-width:900px;margin:22px auto;padding:0 12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:18px}
h1{margin:0 0 6px;text-align:center;font-size:22px} h1 span{color:var(--brand)}
.hint{margin:0 0 14px;text-align:center;color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px} .grid-full{grid-column:1/-1}
.label{font-weight:700;font-size:13px;margin-bottom:6px}
.input,.select,.textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:15px}
.textarea{min-height:84px;resize:vertical}
.hr{height:1px;background:var(--border);margin:12px 0}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{cursor:pointer;flex:1;min-width:140px;border-radius:12px;padding:12px 14px;font-weight:700;border:1px solid var(--border);background:#fff}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)} .btn-danger{border-color:#fecaca;color:#b91c1c}
.small{font-size:12px;color:var(--muted)} .error{color:var(--bad)}
.product{border:1px dashed var(--border);border-radius:12px;padding:12px;margin:8px 0;background:#fff}
@media (max-width:720px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ†• <span>æ–°å•†å“ç”³è«‹</span></h1>
    <p class="hint">æ‰€æœ‰æ¬„ä½å¿…å¡«ã€‚</p>
    <div class="hr"></div>

    <form id="f" novalidate>
      <div class="grid">
        <div><div class="label">åˆ†åº—/å–®ä½ *</div><input class="input" name="store" required placeholder="ä¾‹å¦‚ï¼šå•ƒé…¥XXåº—"></div>
        <div><div class="label">ç”³è«‹äºº *</div><input class="input" name="applicant" required placeholder="ä½ çš„å§“å"></div>
        <div><div class="label">Email *</div><input class="input" name="email" type="email" required placeholder="name@example.com"></div>
        <div><div class="label">é›»è©± *</div><input class="input" name="phone" required placeholder="0900-000-000"></div>
        <div class="grid-full"><div class="label">å‚™è¨» *</div><textarea class="textarea" name="remark" required placeholder="å…¶ä»–è£œå……ã€æ³¨æ„äº‹é …â€¦"></textarea></div>
      </div>

      <div class="hr"></div>
      <div class="label">ç”³è«‹å“é … *</div>
      <div id="products"></div>
      <div class="actions"><button class="btn" type="button" id="add">ï¼‹æ–°å¢ä¸€å€‹å“é …</button></div>

      <div class="actions">
        <button class="btn btn-danger" type="button" id="resetBtn">æ¸…ç©º</button>
        <button class="btn btn-primary" type="submit" id="submitBtn">é€å‡ºç”³è«‹</button>
      </div>
      <div id="msg" class="small" style="margin-top:8px"></div>
    </form>

    <div id="done" style="display:none;text-align:center;padding:16px">
      <h3>âœ… å·²é€å‡º</h3>
      <p class="small">æˆ‘å€‘å·²æ”¶åˆ°ä½ çš„ç”³è«‹ï¼Œè«‹ç•™æ„å¯©æ ¸é€šçŸ¥ã€‚</p>
      <div id="applyNo" class="small" style="margin-top:6px;"></div>
    </div>
  </div>
</div>

<template id="tpl">
  <div class="product">
    <div class="grid">
      <div><div class="label">å•†å“åç¨± *</div><input class="input p-name" required></div>
      <div><div class="label">è¦æ ¼/åŒ…è£ *</div><input class="input p-spec" required></div>
      <div><div class="label">å»ºè­°å”®åƒ¹ *</div><input class="input p-price" required></div>
      <div><div class="label">æˆæœ¬ *</div><input class="input p-cost" required></div>
      <div><div class="label">ç´ åˆ¥ *</div>
        <select class="select p-veg" required>
          <option value="">è«‹é¸æ“‡</option><option>è‘·é£Ÿ</option><option>è›‹å¥¶ç´ </option><option>å¥¶ç´ </option><option>è›‹ç´ </option><option>å…¨ç´ </option>
        </select>
      </div>
      <div><div class="label">éæ•åŸï¼ˆé€—è™Ÿåˆ†éš”ï¼‰*</div><input class="input p-allg" required placeholder="è›‹, å¥¶, èŠ±ç”Ÿâ€¦"></div>
      <div class="grid-full"><div class="label">æˆåˆ†/åŸæ–™ *</div><textarea class="textarea p-ings" required placeholder="ä¸»è¦åŸæ–™â€¦"></textarea></div>
      <div><div class="label">ä¿å­˜æœŸé™ *</div><input class="input p-life" required placeholder="å¸¸æº«/å†·è—/å†·å‡ + æœˆæ•¸"></div>
      <div><div class="label">ä¿å­˜æ–¹å¼ *</div><input class="input p-store" required placeholder="å¸¸æº«/å†·è—/å†·å‡"></div>
      <div><div class="label">ä¾›æ‡‰å‹æ…‹ *</div>
        <select class="select p-supply" required>
          <option>å¸¸æ…‹ä¾›æ‡‰</option><option>å­£ç¯€é™å®š</option><option>è©¦è³£</option>
        </select>
      </div>
      <div><div class="label">é è¨ˆä¸Šæ¶æ—¥ *</div><input class="input p-launch" type="date" required></div>
    </div>
    <div class="actions"><button class="btn btn-danger" type="button" onclick="removeProduct(this)">åˆªé™¤æ­¤å“é …</button></div>
  </div>
</template>

<script>
// ====== éœ€è¦ä½ ç¢ºèªçš„å¸¸æ•¸ï¼ˆå·²å¡«å…¥ä½ æä¾›çš„è³‡æ–™ï¼‰======
const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/ys72eapfco7huad511tph2z91rea6ygc"; // ä½ çš„ Make Webhook
const EMAILJS_SERVICE_ID = "service_qa4j2da";
const EMAILJS_TEMPLATE_ID = "template_m1d2y4g";
const EMAILJS_PUBLIC_KEY = "nMamM2Ecz2ztnkCOV";
// ======================================================

const f = document.getElementById('f');
const addBtn = document.getElementById('add');
const productsBox = document.getElementById('products');
const tpl = document.getElementById('tpl');
const msg = document.getElementById('msg');
const submitBtn = document.getElementById('submitBtn');
const done = document.getElementById('done');
const applyNoEl = document.getElementById('applyNo');

function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});}
function addProduct(){ productsBox.appendChild(tpl.content.cloneNode(true)); }
function removeProduct(btn){
  const card = btn.closest('.product');
  if (productsBox.querySelectorAll('.product').length <= 1) { alert('è‡³å°‘éœ€è¦ä¸€å€‹å“é …'); return; }
  card.remove();
}
addBtn.addEventListener('click', addProduct);
document.getElementById('resetBtn').addEventListener('click', ()=>{ f.reset(); productsBox.innerHTML=''; addProduct(); msg.textContent=''; });

function esc(s){return String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}

// ç”¢ç”Ÿçµ¦ email ç”¨çš„ HTMLï¼ˆä½ å¯ä»¥æ–¼ EmailJS æ¨¡æ¿ä¸­ç”¨ {{products_html}} æ¥ï¼‰
function buildEmailHTML(payload){
  const {apply_no,store,applicant,email,phone,remark,products=[]}=payload;
  let html = `
    <h2 style="margin:0 0 6px;">æ–°å•†å“ç”³è«‹</h2>
    <p style="margin:0 0 8px;">
      <b>åˆ†åº—ï¼š</b>${esc(store)}<br>
      <b>ç”³è«‹äººï¼š</b>${esc(applicant)}ï¼ˆ${esc(email)} / ${esc(phone)}ï¼‰<br>
      <b>ç”³è«‹ç·¨è™Ÿï¼š</b>${esc(apply_no)}<br>
      <b>å‚™è¨»ï¼š</b>${esc(remark)}
    </p>
    <hr style="border:none;border-top:1px solid #eee;margin:10px 0;">`;
  products.forEach((p,i)=>{
    html += `
      <h3 style="margin:10px 0 4px;">${i+1}. ${esc(p.product_name)}</h3>
      <p style="margin:0 0 8px;color:#444;line-height:1.6;">
        è¦æ ¼ï¼š${esc(p.spec)}ï½œå»ºè­°å”®åƒ¹ï¼š${esc(p.price_suggest)}ï½œæˆæœ¬ï¼š${esc(p.cost)}<br>
        ç´ åˆ¥ï¼š${esc(p.vegetarian)}ï½œéæ•åŸï¼š${esc(p.allergens)}<br>
        æˆåˆ†ï¼š${esc(p.ingredients)}<br>
        ä¿å­˜æœŸé™ï¼š${esc(p.shelf_life)}ï½œä¿å­˜æ–¹å¼ï¼š${esc(p.storage)}<br>
        ä¾›æ‡‰å‹æ…‹ï¼š${esc(p.supply_type)}ï½œé è¨ˆä¸Šæ¶æ—¥ï¼š${esc(p.launch_date)}
      </p>`;
  });
  return html;
}

function gather(){
  const products = Array.from(productsBox.querySelectorAll('.product')).map(card=>{
    const get = sel => card.querySelector(sel).value.trim();
    return {
      product_name:get('.p-name'), spec:get('.p-spec'),
      price_suggest:get('.p-price'), cost:get('.p-cost'),
      vegetarian:card.querySelector('.p-veg').value,
      allergens:get('.p-allg'), ingredients:get('.p-ings'),
      shelf_life:get('.p-life'), storage:get('.p-store'),
      supply_type:card.querySelector('.p-supply').value,
      launch_date:card.querySelector('.p-launch').value
    };
  });
  const apply_no = uuid();
  const payload = {
    type:"new_product_application",
    apply_no,
    store: f.store.value.trim(),
    applicant: f.applicant.value.trim(),
    email: f.email.value.trim(),
    phone: f.phone.value.trim(),
    remark: f.remark.value.trim(),
    products
  };

  // ====== Email ä¸»æ—¨ / å…§å®¹ ======
  payload.email_subject = `æ–°å•†å“ç”³è«‹ï½œ${payload.store}ï½œ${apply_no}`;
  // å¯æ”¹æˆå›ºå®šå…§éƒ¨å¯©æ ¸ä¿¡ç®±ï¼›ç›®å‰å…ˆå¯„ç”³è«‹äººï¼ˆEmailJS æ¨¡æ¿ä¹Ÿå¯å¿½ç•¥æ­¤æ¬„ï¼‰
  payload.to_email = payload.email;

  // ä¾› EmailJS æ¨¡æ¿ä½¿ç”¨çš„ HTML å€å¡Š
  payload.products_html = buildEmailHTML(payload);

  // ====== æ‰“åŒ… EmailJS éœ€è¦çš„åƒæ•¸ï¼ˆçµ¦ Make è½‰ç™¼åˆ° EmailJSï¼‰======
  payload.emailjs = {
    service_id: EMAILJS_SERVICE_ID,
    template_id: EMAILJS_TEMPLATE_ID,
    public_key: EMAILJS_PUBLIC_KEY,
    // é€™äº›æ¬„ä½ä½ è¦åœ¨ EmailJS æ¨¡æ¿è£¡å»ºç«‹å°æ‡‰çš„è®Šæ•¸ï¼ˆä¾‹å¦‚ï¼š{{subject}}ã€{{store}}ã€{{applicant}}ã€{{to_email}}ã€{{products_html}} ...ï¼‰
    template_params: {
      subject: payload.email_subject,
      to_email: payload.to_email,
      store: payload.store,
      applicant: payload.applicant,
      applicant_email: payload.email,
      applicant_phone: payload.phone,
      remark: payload.remark,
      apply_no: payload.apply_no,
      products_json: JSON.stringify(products), // è‹¥æ¨¡æ¿æƒ³è‡ªè¡Œè¿­ä»£ä¹Ÿå¯ç”¨é€™æ¬„
      products_html: payload.products_html
    }
  };

  return payload;
}

function validate(){
  const need = [f.store, f.applicant, f.email, f.phone, f.remark];
  for (const el of need){ if(!el.value.trim()) return 'è«‹å®Œæ•´å¡«å¯«å…±åŒæ¬„ä½'; }
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email.value.trim())) return 'Email æ ¼å¼ä¸æ­£ç¢º';
  const cards = productsBox.querySelectorAll('.product');
  if(!cards.length) return 'è«‹è‡³å°‘æ–°å¢ä¸€å€‹å“é …';
  for (const card of cards){
    const req = ['.p-name','.p-spec','.p-price','.p-cost','.p-veg','.p-allg','.p-ings','.p-life','.p-store','.p-supply','.p-launch'];
    for (const sel of req){
      const el = card.querySelector(sel);
      if(!el || !String(el.value||'').trim()) return 'æ¯å€‹å“é …æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«';
    }
  }
  return '';
}

f.addEventListener('submit', async (e)=>{
  e.preventDefault();
  msg.textContent = '';
  const err = validate();
  if (err){ msg.textContent = 'âš ï¸ ' + err; return; }

  const payload = gather();
  submitBtn.disabled = true;

  try{
    const res = await fetch(MAKE_WEBHOOK_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Make å›æ‡‰ç‹€æ…‹ç¢¼ï¼š'+res.status);
    f.style.display='none'; done.style.display='block';
    applyNoEl.textContent = 'ç”³è«‹ç·¨è™Ÿï¼š' + payload.apply_no;
  }catch(e){
    msg.innerHTML = `<span class="error">âŒ é€å‡ºå¤±æ•—ï¼š</span>${e.message||e}`;
  }finally{
    submitBtn.disabled = false;
  }
});

// é è¨­å…ˆä¸€å¼µ
addProduct();
</script>
</body>
</html>
