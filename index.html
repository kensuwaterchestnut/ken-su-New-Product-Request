<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æ–°å•†å“ç”³è«‹</title>
<style>
:root{
  --border:#e5e7eb;--muted:#64748b;--text:#0f172a;
  --brand:#2563eb;--good:#059669;--bad:#dc2626;
  --bg:#f8fafc;--surface:#fff;--yellow:#fffbe6;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif}
.wrap{max-width:900px;margin:22px auto;padding:0 12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:18px}
h1{margin:0 0 6px;text-align:center;font-size:22px;letter-spacing:.04em}
h1 span{color:var(--brand)}
.hint{text-align:center;color:var(--muted);margin:0 0 14px;font-size:13px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-full{grid-column:1/-1}
.label{font-weight:700;font-size:13px;margin-bottom:6px}
.input,.select,.textarea{
  width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:15px
}
.textarea{min-height:84px;resize:vertical}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-size:12px}
.notice{margin-top:10px;background:var(--yellow);border:1px solid #ffe9a8;border-radius:12px;padding:12px;color:#92400e;font-size:13px}
.hr{height:1px;background:var(--border);margin:12px 0}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{cursor:pointer;flex:1;min-width:160px;border-radius:12px;padding:12px 14px;font-weight:700;border:1px solid var(--border);background:#fff}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-danger{background:#fff;border-color:#fecaca;color:#b91c1c}
.btn:disabled{opacity:.6;cursor:not-allowed}
.ok{color:var(--good)} .bad{color:var(--bad)}
.small{font-size:12px;color:var(--muted)}
.success{padding:16px;text-align:center}
.product-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
.preview{display:flex;flex-wrap:wrap;gap:10px}
.thumb{position:relative}
.thumb img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--border);display:block}
.thumb button{
  position:absolute;right:4px;top:4px;border:none;border-radius:999px;
  width:24px;height:24px;background:#0009;color:#fff;cursor:pointer;font-weight:700
}
@media (max-width:720px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ†• <span>æ–°å•†å“ç”³è«‹</span></h1>
    <p class="hint">æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«ï¼›å¯æ–°å¢å¤šå€‹å“é …ï¼Œåœ–ç‰‡å¯å¤šå¼µä¸¦å¯ç§»é™¤ã€‚</p>
    <div class="notice">æé†’ï¼šè«‹å®Œæ•´å¡«å¯« <b>æˆåˆ†/éæ•åŸ/ç´ åˆ¥</b> ä»¥åˆ©å¯©æ ¸ï¼›æ¯å€‹å“é …è‡³å°‘éœ€ 1 å¼µåœ–ç‰‡ã€‚</div>
    <div class="hr"></div>

    <form id="appForm" novalidate>
      <div class="grid">
        <div>
          <div class="label">åˆ†åº—/å–®ä½ *</div>
          <input class="input" name="store" required placeholder="ä¾‹å¦‚ï¼šå•ƒé…¥xxåº—" />
        </div>
        <div>
          <div class="label">ç”³è«‹äºº *</div>
          <input class="input" name="applicant" required placeholder="ä½ çš„å§“å" />
        </div>
        <div>
          <div class="label">Email *</div>
          <input class="input" type="email" name="email" required placeholder="name@example.com" />
        </div>
        <div>
          <div class="label">é›»è©± *</div>
          <input class="input" name="phone" required placeholder="0900-000-000" />
        </div>
        <div class="grid-full">
          <div class="label">å‚™è¨» *</div>
          <textarea class="textarea" name="remark" required placeholder="å…¶ä»–è£œå……ã€æ³¨æ„äº‹é …â€¦"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="label">ç”³è«‹å“é … *</div>
      <div id="products"></div>
      <div class="actions">
        <button class="btn" type="button" id="btnAdd">ï¼‹æ–°å¢ä¸€å€‹å“é …</button>
      </div>

      <div class="actions">
        <button class="btn btn-danger" type="button" id="btnReset">æ¸…ç©º</button>
        <button class="btn btn-primary" type="submit" id="btnSubmit">é€å‡ºç”³è«‹</button>
      </div>
      <div id="msg" class="small" style="margin-top:8px"></div>
    </form>

    <div id="done" class="success" style="display:none">
      <h3>âœ… å·²é€å‡º</h3>
      <p class="small">å·²å¯«å…¥è¡¨å–®ä¸¦é€šçŸ¥ç¸½éƒ¨ï¼Œè«‹ç•™æ„å¯©æ ¸é€šçŸ¥ã€‚</p>
      <div id="applyNo" class="badge"></div>
    </div>
  </div>
</div>

<!-- ===== ç”¢å“å¡ç‰‡æ¨¡æ¿ ===== -->
<template id="tplProduct">
  <div class="product-card">
    <div class="grid">
      <div>
        <div class="label">å•†å“åç¨± *</div>
        <input class="input p-name" required />
      </div>
      <div>
        <div class="label">è¦æ ¼/åŒ…è£ *</div>
        <input class="input p-spec" required />
      </div>

      <div>
        <div class="label">å»ºè­°å”®åƒ¹ *</div>
        <input class="input p-price" required />
      </div>
      <div>
        <div class="label">æˆæœ¬ *</div>
        <input class="input p-cost" required />
      </div>

      <div>
        <div class="label">ç´ åˆ¥ *</div>
        <select class="select p-veg" required>
          <option value="">è«‹é¸æ“‡</option>
          <option>è‘·é£Ÿ</option><option>è›‹å¥¶ç´ </option><option>å¥¶ç´ </option>
          <option>è›‹ç´ </option><option>å…¨ç´ </option>
        </select>
      </div>
      <div>
        <div class="label">éæ•åŸï¼ˆé€—è™Ÿåˆ†éš”ï¼‰*</div>
        <input class="input p-allg" required placeholder="è›‹, å¥¶, èŠ±ç”Ÿâ€¦" />
      </div>

      <div class="grid-full">
        <div class="label">æˆåˆ†/åŸæ–™ *</div>
        <textarea class="textarea p-ings" required placeholder="ä¸»è¦åŸæ–™â€¦"></textarea>
      </div>

      <div>
        <div class="label">ä¿å­˜æœŸé™ *</div>
        <input class="input p-life" required placeholder="å¸¸æº«/å†·è—/å†·å‡ + æœˆæ•¸" />
      </div>
      <div>
        <div class="label">ä¿å­˜æ–¹å¼ *</div>
        <input class="input p-store" required placeholder="å¸¸æº«/å†·è—/å†·å‡" />
      </div>

      <div>
        <div class="label">ä¾›æ‡‰å‹æ…‹ *</div>
        <select class="select p-supply" required>
          <option>å¸¸æ…‹ä¾›æ‡‰</option><option>å­£ç¯€é™å®š</option><option>è©¦è³£</option>
        </select>
      </div>
      <div>
        <div class="label">é è¨ˆä¸Šæ¶æ—¥ *</div>
        <input class="input p-launch" type="date" required />
      </div>

      <div class="grid-full">
        <div class="label">å•†å“åœ–ç‰‡ï¼ˆè‡³å°‘ 1 å¼µï¼‰*</div>
        <input class="input p-files" type="file" accept="image/*" multiple />
        <div class="preview p-preview" style="margin-top:6px"></div>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-danger" type="button" onclick="removeProduct(this)">åˆªé™¤æ­¤å“é …</button>
    </div>
  </div>
</template>

<script>
/* ========= å·¥å…· ========= */
function uuid(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0, v=c=='x'?r:(r&0x3|0x8); return v.toString(16);
  });
}
function loadImage(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = e => resolve(e.target.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
// ç°¡å–®å£“ç¸®ï¼ˆé•·é‚Š â‰¤ 1600ï¼‰
function compressBase64(dataUrl, mime){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{
      const max = 1600;
      let w = img.naturalWidth, h = img.naturalHeight;
      if (Math.max(w,h) > max){
        if (w > h){ h = Math.round(h * (max / w)); w = max; }
        else { w = Math.round(w * (max / h)); h = max; }
      }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL(mime || 'image/jpeg', 0.9));
    };
    img.src = dataUrl;
  });
}

/* ========= DOM ========= */
const form = document.getElementById('appForm');
const btnAdd = document.getElementById('btnAdd');
const btnSubmit = document.getElementById('btnSubmit');
const btnReset = document.getElementById('btnReset');
const msg = document.getElementById('msg');
const done = document.getElementById('done');
const applyNoEl = document.getElementById('applyNo');
const productsWrap = document.getElementById('products');
const tpl = document.getElementById('tplProduct');

/* ========= ç”¢å“å¡é‚è¼¯ ========= */
// æ¯å¼µå¡ç¶­è­·è‡ªå·±çš„ imageListï¼ˆArray<{name, type, dataUrl}>ï¼‰
function addProductCard(){
  const node = tpl.content.cloneNode(true);
  const card = node.querySelector('.product-card');
  card.imageList = []; // è‡ªæœ‰ç‹€æ…‹

  const input = node.querySelector('.p-files');
  const prev = node.querySelector('.p-preview');

  function renderPreview(){
    prev.innerHTML = '';
    card.imageList.forEach((imgObj, idx)=>{
      const wrap = document.createElement('div'); wrap.className='thumb';
      const img = document.createElement('img'); img.src = imgObj.dataUrl;
      const del = document.createElement('button'); del.type='button'; del.textContent='Ã—';
      del.title = 'ç§»é™¤';
      del.addEventListener('click', ()=>{
        card.imageList.splice(idx,1);
        renderPreview();
      });
      wrap.appendChild(img); wrap.appendChild(del); prev.appendChild(wrap);
    });
  }

  input.addEventListener('change', async ()=>{
    const files = Array.from(input.files||[]);
    for (const f of files){
      const raw = await loadImage(f);
      const dataUrl = await compressBase64(raw, f.type);
      card.imageList.push({ name: f.name, type: f.type || 'image/jpeg', dataUrl });
    }
    input.value = ''; // æ¸…ç©ºï¼Œé¿å…é‡è¤‡é¸æ“‡åŒæª”æ¡ˆäº‹ä»¶ä¸è§¸ç™¼
    renderPreview();
  });

  productsWrap.appendChild(node);
}
function removeProduct(btn){
  const card = btn.closest('.product-card');
  if (productsWrap.querySelectorAll('.product-card').length <= 1){
    alert('è‡³å°‘éœ€è¦ä¸€å€‹å“é …'); return;
  }
  card.remove();
}

btnAdd.addEventListener('click', addProductCard);
// é è¨­ä¸€å¼µ
addProductCard();

/* ========= é€å‡º ========= */
btnReset.addEventListener('click', ()=>{
  form.reset(); msg.textContent=''; productsWrap.innerHTML=''; addProductCard();
});

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  msg.textContent=''; btnSubmit.disabled = true;

  // å…±åŒæ¬„ä½å¿…å¡«æª¢æŸ¥ï¼ˆæ‰€æœ‰æ¬„ä½å¿…å¡«ï¼‰
  const commons = ['store','applicant','email','phone','remark'];
  for (const n of commons){
    const el = form.elements[n];
    if (!el || !el.value.trim()){
      msg.textContent = 'âš ï¸ è«‹å®Œæ•´å¡«å¯«å…±åŒæ¬„ä½';
      btnSubmit.disabled = false; return;
    }
  }
  // Email åŸºæœ¬æ ¼å¼
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.email.value.trim())){
    msg.textContent = 'âš ï¸ Email æ ¼å¼ä¸æ­£ç¢º';
    btnSubmit.disabled = false; return;
  }

  const productCards = Array.from(productsWrap.querySelectorAll('.product-card'));
  if (!productCards.length){ msg.textContent='âš ï¸ è«‹è‡³å°‘æ–°å¢ä¸€å€‹å“é …'; btnSubmit.disabled=false; return; }

  const applyNo = uuid();
  // ç°¡å–®å»é‡ï¼ˆå‰ç«¯ï¼‰
  const sentNos = JSON.parse(localStorage.getItem('appliedNos')||'[]');
  sentNos.push(applyNo); localStorage.setItem('appliedNos', JSON.stringify(sentNos));

  try{
    // æ”¶é›†å“é …è³‡æ–™ + ä¸Šå‚³åœ–ç‰‡
    const products = [];
    for (const card of productCards){
      const get = sel => card.querySelector(sel);
      const item = {
        product_name: get('.p-name').value.trim(),
        spec:         get('.p-spec').value.trim(),
        price_suggest:get('.p-price').value.trim(),
        cost:         get('.p-cost').value.trim(),
        vegetarian:   get('.p-veg').value,
        allergens:    get('.p-allg').value.trim(),
        ingredients:  get('.p-ings').value.trim(),
        shelf_life:   get('.p-life').value.trim(),
        storage:      get('.p-store').value.trim(),
        supply_type:  get('.p-supply').value,
        launch_date:  get('.p-launch').value,
      };
      // æ¯å€‹æ¬„ä½å¿…å¡«
      for (const [k,v] of Object.entries(item)){
        if (!String(v||'').trim()){
          msg.textContent = 'âš ï¸ æ¯å€‹å“é …æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«';
          btnSubmit.disabled=false; return;
        }
      }
      // åœ–ç‰‡å¿…å¡«ï¼šè‡³å°‘ 1 å¼µ
      if (!card.imageList || !card.imageList.length){
        msg.textContent = 'âš ï¸ æ¯å€‹å“é …è‡³å°‘éœ€ 1 å¼µåœ–ç‰‡';
        btnSubmit.disabled=false; return;
      }

      // ä¸Šå‚³åœ–ç‰‡åˆ° Drive
      const payload = {
        items: card.imageList.map(x=>({ name:x.name, mime:x.type, base64:x.dataUrl }))
      };
      const imagesMeta = await new Promise((resolve,reject)=>{
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
          .saveImages(payload);
      });

      products.push({ ...item, images: imagesMeta });
    }

    // çµ„å…±åŒè³‡è¨Š + å¤šå“é …é€å¾Œç«¯
    const data = {
      apply_no: applyNo,
      store: form.store.value.trim(),
      applicant: form.applicant.value.trim(),
      email: form.email.value.trim(),
      phone: form.phone.value.trim(),
      remark: form.remark.value.trim(),
      products
    };

    const res = await new Promise((resolve,reject)=>{
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
        .createApplications(data);
    });

    if (res && res.dedup){
      msg.textContent = 'âš ï¸ é‡è¤‡ç”³è«‹ï¼ˆåŒç”³è«‹ç·¨è™Ÿï¼‰ï¼Œå·²ç•¥é';
      btnSubmit.disabled=false; return;
    }

    // å®Œæˆ
    form.style.display='none';
    done.style.display='block';
    applyNoEl.textContent = 'ç”³è«‹ç·¨è™Ÿï¼š' + (res.apply_no || applyNo);
  }catch(err){
    console.error(err);
    msg.textContent = 'âŒ é€å‡ºå¤±æ•—ï¼š' + (err?.message || err);
    btnSubmit.disabled=false;
  }
});
</script>
</body>
</html>
