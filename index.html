<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æ–°å•†å“ç”³è«‹</title>
<style>
:root{
  --border:#e5e7eb;--muted:#64748b;--text:#0f172a;
  --brand:#2563eb;--good:#059669;--bad:#dc2626;
  --bg:#f8fafc;--surface:#fff;--yellow:#fffbe6;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif}
.wrap{max-width:860px;margin:24px auto;padding:0 12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:18px}
h1{margin:0 0 6px;text-align:center;font-size:22px;letter-spacing:.04em}
h1 span{color:var(--brand)}
.hint{text-align:center;color:var(--muted);margin:0 0 14px;font-size:13px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.label{font-weight:700;font-size:13px;margin-bottom:6px}
.input,.select,.textarea{
  width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:15px
}
.textarea{min-height:84px;resize:vertical}
.row{display:grid;gap:10px}
@media (min-width:720px){
  .grid{grid-template-columns:1fr 1fr}
}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-size:12px}
.notice{
  margin-top:10px;background:var(--yellow);border:1px solid #ffe9a8;border-radius:12px;padding:12px;color:#92400e;font-size:13px
}
.hr{height:1px;background:var(--border);margin:10px 0}
.preview{display:flex;flex-wrap:wrap;gap:10px}
.preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{cursor:pointer;flex:1;min-width:160px;border-radius:12px;padding:12px 14px;font-weight:700;border:1px solid var(--border);background:#fff}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.ok{color:var(--good)} .bad{color:var(--bad)}
.small{font-size:12px;color:var(--muted)}
.success{padding:16px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ†• <span>æ–°å•†å“ç”³è«‹</span></h1>
    <p class="hint">ä¸Šå‚³åœ–ç‰‡èˆ‡è³‡æ–™ï¼Œé€å‡ºå¾Œè‡ªå‹•é€šçŸ¥ç¸½éƒ¨ä¸¦å¯«å…¥è¡¨å–®</p>

    <div class="notice">æé†’ï¼šè«‹å®Œæ•´å¡«å¯« <b>æˆåˆ†/éæ•åŸ/ç´ åˆ¥</b>ï¼Œä»¥åˆ©å¯©æ ¸ã€‚</div>

    <div class="hr"></div>

    <!-- è¡¨å–® -->
    <form id="appForm">
      <div class="grid">
        <div>
          <div class="label">åˆ†åº—/å–®ä½ *</div>
          <input class="input" name="store" required placeholder="ä¾‹å¦‚ï¼šå•ƒé…¥ç¸½éƒ¨-å°æ´‹" />
        </div>
        <div>
          <div class="label">ç”³è«‹äºº *</div>
          <input class="input" name="applicant" required placeholder="ä½ çš„å§“å" />
        </div>
        <div>
          <div class="label">Email *</div>
          <input class="input" type="email" name="email" required placeholder="name@example.com" />
        </div>
        <div>
          <div class="label">é›»è©±</div>
          <input class="input" name="phone" placeholder="0900-000-000" />
        </div>

        <div>
          <div class="label">å•†å“åç¨± *</div>
          <input class="input" name="product_name" required placeholder="ä¾‹å¦‚ï¼šç‰ç±³å¸ƒä¸é…¥" />
        </div>
        <div>
          <div class="label">è¦æ ¼/åŒ…è£</div>
          <input class="input" name="spec" placeholder="é‡é‡ã€å…¥æ•¸ã€åŒ…è£æ–¹å¼â€¦" />
        </div>

        <div>
          <div class="label">å»ºè­°å”®åƒ¹</div>
          <input class="input" name="price_suggest" placeholder="$" />
        </div>
        <div>
          <div class="label">æˆæœ¬</div>
          <input class="input" name="cost" placeholder="$" />
        </div>

        <div>
          <div class="label">ç´ åˆ¥ *</div>
          <select class="select" name="vegetarian" required>
            <option value="">è«‹é¸æ“‡</option>
            <option>è‘·é£Ÿ</option>
            <option>è›‹å¥¶ç´ </option>
            <option>å¥¶ç´ </option>
            <option>è›‹ç´ </option>
            <option>å…¨ç´ </option>
          </select>
        </div>
        <div>
          <div class="label">éæ•åŸï¼ˆå¤šé¸ä»¥é€—è™Ÿåˆ†éš”ï¼‰</div>
          <input class="input" name="allergens" placeholder="è›‹, å¥¶, èŠ±ç”Ÿ, å …æœ, è¦, èŸ¹, å¤§è±†, éº©è³ªâ€¦" />
        </div>

        <div style="grid-column:1/-1">
          <div class="label">æˆåˆ†/åŸæ–™ *</div>
          <textarea class="textarea" name="ingredients" required placeholder="è«‹è©³åˆ—ä¸»è¦åŸæ–™ï¼Œä¾‹ï¼šé¦¬éˆ´è–¯ã€è‘µèŠ±æ²¹ã€ä¿®é£¾æ¾±ç²‰(é†‹é…¸æ¾±ç²‰ã€ç£·é…¸äºŒæ¾±ç²‰)â€¦"></textarea>
        </div>

        <div>
          <div class="label">ä¿å­˜æœŸé™</div>
          <input class="input" name="shelf_life" placeholder="ä¾‹å¦‚ï¼šå†·å‡ 12 å€‹æœˆ / å¸¸æº« 6 å€‹æœˆ" />
        </div>
        <div>
          <div class="label">ä¿å­˜æ–¹å¼</div>
          <input class="input" name="storage" placeholder="å¸¸æº«/å†·è—/å†·å‡" />
        </div>

        <div>
          <div class="label">ä¾›æ‡‰å‹æ…‹</div>
          <select class="select" name="supply_type">
            <option>å¸¸æ…‹ä¾›æ‡‰</option>
            <option>å­£ç¯€é™å®š</option>
            <option>è©¦è³£</option>
          </select>
        </div>
        <div>
          <div class="label">é è¨ˆä¸Šæ¶æ—¥</div>
          <input class="input" type="date" name="launch_date" />
        </div>

        <div style="grid-column:1/-1">
          <div class="label">å•†å“åœ–ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</div>
          <input class="input" id="images" type="file" accept="image/*" multiple />
          <div id="preview" class="preview" aria-live="polite"></div>
          <div class="small">æ”¯æ´ JPG/PNG/WebP/GIFï¼Œæœƒè‡ªå‹•å£“ç¸®é•·é‚Šâ‰¤1600pxã€‚</div>
        </div>

        <div style="grid-column:1/-1">
          <div class="label">å‚™è¨»</div>
          <textarea class="textarea" name="remark" placeholder="å…¶ä»–è£œå……ã€æ³¨æ„äº‹é …â€¦"></textarea>
        </div>
      </div>

      <div class="actions">
        <button class="btn" type="button" id="btnReset">æ¸…ç©º</button>
        <button class="btn btn-primary" type="submit" id="btnSubmit">é€å‡ºç”³è«‹</button>
      </div>
      <div id="msg" class="small" style="margin-top:8px"></div>
    </form>

    <div id="done" class="success" style="display:none">
      <h3>âœ… å·²é€å‡º</h3>
      <p class="small">å·²å¯«å…¥è¡¨å–®ä¸¦é€šçŸ¥ç¸½éƒ¨ï¼Œè«‹ç•™æ„å¯©æ ¸é€šçŸ¥ã€‚</p>
      <div id="applyNo" class="badge"></div>
    </div>
  </div>
</div>

<script>
/* ===== å½±åƒå£“ç¸®å¾Œè½‰ base64 ===== */
function loadImage(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = e => resolve(e.target.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
// ç°¡å–®å£“ç¸®ï¼ˆé•·é‚Šâ‰¤1600ï¼‰
async function compressBase64(dataUrl, mime){
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const max = 1600;
      let { width:w, height:h } = img;
      if (Math.max(w,h) > max){
        if (w > h){ h = Math.round(h * (max / w)); w = max; }
        else { w = Math.round(w * (max / h)); h = max; }
      }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      const out = canvas.toDataURL(mime || 'image/jpeg', 0.9);
      resolve(out);
    };
    img.src = dataUrl;
  });
}

/* ===== UIï¼šé è¦½ ===== */
const inputImages = document.getElementById('images');
const preview = document.getElementById('preview');
inputImages.addEventListener('change', async () => {
  preview.innerHTML = '';
  const files = Array.from(inputImages.files || []);
  for (const f of files){
    const url = URL.createObjectURL(f);
    const img = document.createElement('img'); img.src = url;
    preview.appendChild(img);
  }
});

/* ===== è¡¨å–®æäº¤ ===== */
const form = document.getElementById('appForm');
const btnSubmit = document.getElementById('btnSubmit');
const btnReset = document.getElementById('btnReset');
const msg = document.getElementById('msg');
const done = document.getElementById('done');
const applyNoEl = document.getElementById('applyNo');

btnReset.addEventListener('click', () => { form.reset(); preview.innerHTML=''; msg.textContent=''; });

function uuid(){
  // ç°¡åŒ– uuid
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r = Math.random()*16|0, v = c=='x'?r:(r&0x3|0x8); return v.toString(16);
  });
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  msg.textContent = '';
  btnSubmit.disabled = true;

  // å¿…å¡«æª¢æŸ¥ï¼ˆåŸºæœ¬ï¼‰
  const req = ['store','applicant','email','product_name','vegetarian','ingredients'];
  for (const name of req){
    const el = form.elements[name];
    if (!el || !el.value.trim()){ msg.innerHTML = 'âš ï¸ è«‹å®Œæ•´å¡«å¯«å¿…å¡«æ¬„ä½'; btnSubmit.disabled=false; return; }
  }

  // å»é‡ï¼šåŒç”³è«‹ç·¨è™Ÿä¸é‡è¤‡é€ï¼ˆLocalStorageï¼‰
  const applyNo = uuid();
  const sent = JSON.parse(localStorage.getItem('appliedNos')||'[]');
  sent.push(applyNo); localStorage.setItem('appliedNos', JSON.stringify(sent));

  try{
    // 1) è™•ç†åœ–ç‰‡ï¼šå£“ç¸®â†’base64â†’ä¸Šå‚³ Drive
    const files = Array.from(inputImages.files || []);
    let items = [];
    for (const f of files){
      const dataUrl = await loadImage(f);
      const out = await compressBase64(dataUrl, f.type);
      items.push({ name: f.name, mime: f.type || 'image/jpeg', base64: out });
    }
    let imagesMeta = [];
    if (items.length){
      imagesMeta = await new Promise((resolve,reject)=>{
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
          .saveImages({ items });
      });
    }

    // 2) çµ„è³‡æ–™
    const data = {
      idempotencyKey: applyNo,
      apply_no: applyNo,
      store: form.store.value.trim(),
      applicant: form.applicant.value.trim(),
      email: form.email.value.trim(),
      phone: form.phone.value.trim(),
      product_name: form.product_name.value.trim(),
      spec: form.spec.value.trim(),
      price_suggest: form.price_suggest.value.trim(),
      cost: form.cost.value.trim(),
      vegetarian: form.vegetarian.value,
      allergens: form.allergens.value.trim(),
      ingredients: form.ingredients.value.trim(),
      shelf_life: form.shelf_life.value.trim(),
      storage: form.storage.value.trim(),
      supply_type: form.supply_type.value,
      launch_date: form.launch_date.value,
      remark: form.remark.value.trim(),
      images: imagesMeta
    };

    // 3) å¯«å…¥èˆ‡é€šçŸ¥
    const res = await new Promise((resolve,reject)=>{
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
        .createApplication(data);
    });

    if (res && res.dedup){
      msg.innerHTML = 'âš ï¸ é‡è¤‡ç”³è«‹ï¼Œå·²ç•¥éé€å‡º';
      btnSubmit.disabled = false;
      return;
    }

    // 4) çµæœ
    form.style.display = 'none';
    done.style.display = 'block';
    applyNoEl.textContent = 'ç”³è«‹ç·¨è™Ÿï¼š' + (res.apply_no || applyNo);
  }catch(err){
    console.error(err);
    msg.innerHTML = 'âŒ é€å‡ºå¤±æ•—ï¼š' + (err && err.message ? err.message : err);
    btnSubmit.disabled = false;
  }
});
</script>
</body>
</html>
