<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>新商品申請</title>
<style>
:root{
  --border:#e5e7eb;--muted:#64748b;--text:#0f172a;
  --brand:#2563eb;--good:#059669;--bad:#dc2626;
  --bg:#f8fafc;--surface:#fff;--yellow:#fffbe6;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif}
.wrap{max-width:900px;margin:22px auto;padding:0 12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:18px}
h1{margin:0 0 6px;text-align:center;font-size:22px;letter-spacing:.04em}
h1 span{color:var(--brand)}
.hint{text-align:center;color:var(--muted);margin:0 0 14px;font-size:13px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-full{grid-column:1/-1}
.label{font-weight:700;font-size:13px;margin-bottom:6px}
.input,.select,.textarea{
  width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:15px
}
.textarea{min-height:84px;resize:vertical}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1d4ed8;font-size:12px}
.notice{margin-top:10px;background:var(--yellow);border:1px solid #ffe9a8;border-radius:12px;padding:12px;color:#92400e;font-size:13px}
.hr{height:1px;background:var(--border);margin:12px 0}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{cursor:pointer;flex:1;min-width:160px;border-radius:12px;padding:12px 14px;font-weight:700;border:1px solid var(--border);background:#fff}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-danger{background:#fff;border-color:#fecaca;color:#b91c1c}
.btn:disabled{opacity:.6;cursor:not-allowed}
.ok{color:var(--good)} .bad{color:var(--bad)}
.small{font-size:12px;color:var(--muted)}
.success{padding:16px;text-align:center}
.product-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
.preview{display:flex;flex-wrap:wrap;gap:10px}
.thumb{position:relative}
.thumb img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--border);display:block}
.thumb button{
  position:absolute;right:4px;top:4px;border:none;border-radius:999px;
  width:24px;height:24px;background:#0009;color:#fff;cursor:pointer;font-weight:700
}
@media (max-width:720px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>🆕 <span>新商品申請</span></h1>
    <p class="hint">所有欄位皆為必填；可新增多個品項，圖片可多張並可移除。</p>
    <div class="notice">提醒：請完整填寫 <b>成分/過敏原/素別</b> 以利審核；每個品項至少需 1 張圖片。</div>
    <div class="hr"></div>

    <form id="appForm" novalidate>
      <div class="grid">
        <div>
          <div class="label">分店/單位 *</div>
          <input class="input" name="store" required placeholder="例如：啃酥xx店" />
        </div>
        <div>
          <div class="label">申請人 *</div>
          <input class="input" name="applicant" required placeholder="你的姓名" />
        </div>
        <div>
          <div class="label">Email *</div>
          <input class="input" type="email" name="email" required placeholder="name@example.com" />
        </div>
        <div>
          <div class="label">電話 *</div>
          <input class="input" name="phone" required placeholder="0900-000-000" />
        </div>
        <div class="grid-full">
          <div class="label">備註 *</div>
          <textarea class="textarea" name="remark" required placeholder="其他補充、注意事項…"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="label">申請品項 *</div>
      <div id="products"></div>
      <div class="actions">
        <button class="btn" type="button" id="btnAdd">＋新增一個品項</button>
      </div>

      <div class="actions">
        <button class="btn btn-danger" type="button" id="btnReset">清空</button>
        <button class="btn btn-primary" type="submit" id="btnSubmit">送出申請</button>
      </div>
      <div id="msg" class="small" style="margin-top:8px"></div>
    </form>

    <div id="done" class="success" style="display:none">
      <h3>✅ 已送出</h3>
      <p class="small">已寫入表單並通知總部，請留意審核通知。</p>
      <div id="applyNo" class="badge"></div>
    </div>
  </div>
</div>

<!-- ===== 產品卡片模板 ===== -->
<template id="tplProduct">
  <div class="product-card">
    <div class="grid">
      <div>
        <div class="label">商品名稱 *</div>
        <input class="input p-name" required />
      </div>
      <div>
        <div class="label">規格/包裝 *</div>
        <input class="input p-spec" required />
      </div>

      <div>
        <div class="label">建議售價 *</div>
        <input class="input p-price" required />
      </div>
      <div>
        <div class="label">成本 *</div>
        <input class="input p-cost" required />
      </div>

      <div>
        <div class="label">素別 *</div>
        <select class="select p-veg" required>
          <option value="">請選擇</option>
          <option>葷食</option><option>蛋奶素</option><option>奶素</option>
          <option>蛋素</option><option>全素</option>
        </select>
      </div>
      <div>
        <div class="label">過敏原（逗號分隔）*</div>
        <input class="input p-allg" required placeholder="蛋, 奶, 花生…" />
      </div>

      <div class="grid-full">
        <div class="label">成分/原料 *</div>
        <textarea class="textarea p-ings" required placeholder="主要原料…"></textarea>
      </div>

      <div>
        <div class="label">保存期限 *</div>
        <input class="input p-life" required placeholder="常溫/冷藏/冷凍 + 月數" />
      </div>
      <div>
        <div class="label">保存方式 *</div>
        <input class="input p-store" required placeholder="常溫/冷藏/冷凍" />
      </div>

      <div>
        <div class="label">供應型態 *</div>
        <select class="select p-supply" required>
          <option>常態供應</option><option>季節限定</option><option>試賣</option>
        </select>
      </div>
      <div>
        <div class="label">預計上架日 *</div>
        <input class="input p-launch" type="date" required />
      </div>

      <div class="grid-full">
        <div class="label">商品圖片（至少 1 張）*</div>
        <input class="input p-files" type="file" accept="image/*" multiple />
        <div class="preview p-preview" style="margin-top:6px"></div>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-danger" type="button" onclick="removeProduct(this)">刪除此品項</button>
    </div>
  </div>
</template>

<script>
/* ========= 工具 ========= */
function uuid(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0, v=c=='x'?r:(r&0x3|0x8); return v.toString(16);
  });
}
function loadImage(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = e => resolve(e.target.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
// 簡單壓縮（長邊 ≤ 1600）
function compressBase64(dataUrl, mime){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{
      const max = 1600;
      let w = img.naturalWidth, h = img.naturalHeight;
      if (Math.max(w,h) > max){
        if (w > h){ h = Math.round(h * (max / w)); w = max; }
        else { w = Math.round(w * (max / h)); h = max; }
      }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL(mime || 'image/jpeg', 0.9));
    };
    img.src = dataUrl;
  });
}

/* ========= DOM ========= */
const form = document.getElementById('appForm');
const btnAdd = document.getElementById('btnAdd');
const btnSubmit = document.getElementById('btnSubmit');
const btnReset = document.getElementById('btnReset');
const msg = document.getElementById('msg');
const done = document.getElementById('done');
const applyNoEl = document.getElementById('applyNo');
const productsWrap = document.getElementById('products');
const tpl = document.getElementById('tplProduct');

/* ========= 產品卡邏輯 ========= */
// 每張卡維護自己的 imageList（Array<{name, type, dataUrl}>）
function addProductCard(){
  const node = tpl.content.cloneNode(true);
  const card = node.querySelector('.product-card');
  card.imageList = []; // 自有狀態

  const input = node.querySelector('.p-files');
  const prev = node.querySelector('.p-preview');

  function renderPreview(){
    prev.innerHTML = '';
    card.imageList.forEach((imgObj, idx)=>{
      const wrap = document.createElement('div'); wrap.className='thumb';
      const img = document.createElement('img'); img.src = imgObj.dataUrl;
      const del = document.createElement('button'); del.type='button'; del.textContent='×';
      del.title = '移除';
      del.addEventListener('click', ()=>{
        card.imageList.splice(idx,1);
        renderPreview();
      });
      wrap.appendChild(img); wrap.appendChild(del); prev.appendChild(wrap);
    });
  }

  input.addEventListener('change', async ()=>{
    const files = Array.from(input.files||[]);
    for (const f of files){
      const raw = await loadImage(f);
      const dataUrl = await compressBase64(raw, f.type);
      card.imageList.push({ name: f.name, type: f.type || 'image/jpeg', dataUrl });
    }
    input.value = ''; // 清空，避免重複選擇同檔案事件不觸發
    renderPreview();
  });

  productsWrap.appendChild(node);
}
function removeProduct(btn){
  const card = btn.closest('.product-card');
  if (productsWrap.querySelectorAll('.product-card').length <= 1){
    alert('至少需要一個品項'); return;
  }
  card.remove();
}

btnAdd.addEventListener('click', addProductCard);
// 預設一張
addProductCard();

/* ========= 送出 ========= */
btnReset.addEventListener('click', ()=>{
  form.reset(); msg.textContent=''; productsWrap.innerHTML=''; addProductCard();
});

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  msg.textContent=''; btnSubmit.disabled = true;

  // 共同欄位必填檢查（所有欄位必填）
  const commons = ['store','applicant','email','phone','remark'];
  for (const n of commons){
    const el = form.elements[n];
    if (!el || !el.value.trim()){
      msg.textContent = '⚠️ 請完整填寫共同欄位';
      btnSubmit.disabled = false; return;
    }
  }
  // Email 基本格式
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.email.value.trim())){
    msg.textContent = '⚠️ Email 格式不正確';
    btnSubmit.disabled = false; return;
  }

  const productCards = Array.from(productsWrap.querySelectorAll('.product-card'));
  if (!productCards.length){ msg.textContent='⚠️ 請至少新增一個品項'; btnSubmit.disabled=false; return; }

  const applyNo = uuid();
  // 簡單去重（前端）
  const sentNos = JSON.parse(localStorage.getItem('appliedNos')||'[]');
  sentNos.push(applyNo); localStorage.setItem('appliedNos', JSON.stringify(sentNos));

  try{
    // 收集品項資料 + 上傳圖片
    const products = [];
    for (const card of productCards){
      const get = sel => card.querySelector(sel);
      const item = {
        product_name: get('.p-name').value.trim(),
        spec:         get('.p-spec').value.trim(),
        price_suggest:get('.p-price').value.trim(),
        cost:         get('.p-cost').value.trim(),
        vegetarian:   get('.p-veg').value,
        allergens:    get('.p-allg').value.trim(),
        ingredients:  get('.p-ings').value.trim(),
        shelf_life:   get('.p-life').value.trim(),
        storage:      get('.p-store').value.trim(),
        supply_type:  get('.p-supply').value,
        launch_date:  get('.p-launch').value,
      };
      // 每個欄位必填
      for (const [k,v] of Object.entries(item)){
        if (!String(v||'').trim()){
          msg.textContent = '⚠️ 每個品項所有欄位皆為必填';
          btnSubmit.disabled=false; return;
        }
      }
      // 圖片必填：至少 1 張
      if (!card.imageList || !card.imageList.length){
        msg.textContent = '⚠️ 每個品項至少需 1 張圖片';
        btnSubmit.disabled=false; return;
      }

      // 上傳圖片到 Drive
      const payload = {
        items: card.imageList.map(x=>({ name:x.name, mime:x.type, base64:x.dataUrl }))
      };
      const imagesMeta = await new Promise((resolve,reject)=>{
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
          .saveImages(payload);
      });

      products.push({ ...item, images: imagesMeta });
    }

    // 組共同資訊 + 多品項送後端
    const data = {
      apply_no: applyNo,
      store: form.store.value.trim(),
      applicant: form.applicant.value.trim(),
      email: form.email.value.trim(),
      phone: form.phone.value.trim(),
      remark: form.remark.value.trim(),
      products
    };

    const res = await new Promise((resolve,reject)=>{
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
        .createApplications(data);
    });

    if (res && res.dedup){
      msg.textContent = '⚠️ 重複申請（同申請編號），已略過';
      btnSubmit.disabled=false; return;
    }

    // 完成
    form.style.display='none';
    done.style.display='block';
    applyNoEl.textContent = '申請編號：' + (res.apply_no || applyNo);
  }catch(err){
    console.error(err);
    msg.textContent = '❌ 送出失敗：' + (err?.message || err);
    btnSubmit.disabled=false;
  }
});
</script>
</body>
</html>
